name: Build extensions

on:
  push:
    branches:
      - '*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: X64
          - os: ubuntu-arm64-latest
            arch: ARM64
          - os: windows-latest
            arch: X64
          - os: macos-latest
            arch: X64
          - os: macos-latest-xlarge
            arch: ARM64
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Download SQLite headers (Unix)
      if: runner.os != 'Windows'
      run: cd extensions && make headers

    - name: Download SQLite headers (Windows)
      if: runner.os == 'Windows'
      run: |
        cd extensions
        curl.exe -L https://www.sqlite.org/2024/sqlite-amalgamation-3470200.zip -o sqlite-src.zip
        Expand-Archive -Path sqlite-src.zip -DestinationPath .
        Copy-Item sqlite-amalgamation-3470200\sqlite3.h .
        Copy-Item sqlite-amalgamation-3470200\sqlite3ext.h .

    - name: Build C files
      run: cd extensions && make VERBOSE=1

    - name: Commit output files
      run: |
        cd extensions
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add lib/
        git commit -m "Auto-build: Update output files [skip ci]" || echo "No changes to commit"
        for attempt in {1..3}; do
          git pull --rebase && git push && break || sleep 5
        done
